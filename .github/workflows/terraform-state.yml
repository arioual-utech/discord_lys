# =============================================================================
# Opérations sur le state Terraform (Linux uniquement — provider discord pas dispo sur Windows)
# Utiliser ces actions pour state pull / state push depuis la CI.
# =============================================================================

name: Terraform State

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Opération à effectuer'
        required: true
        type: choice
        options:
          - state-pull
          - state-push
      state_file_path:
        description: 'Chemin du fichier state à pousser (pour state-push)'
        required: false
        default: 'terraform.tfstate.push'

env:
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

jobs:
  # ---------------------------------------------------------------------------
  # State pull : récupère le state depuis Terraform Cloud, le met en artifact
  # ---------------------------------------------------------------------------
  state-pull:
    name: State Pull
    runs-on: ubuntu-latest
    if: github.event.inputs.operation == 'state-pull'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        run: terraform init

      - name: State Pull
        run: terraform state pull > terraform.tfstate.pulled

      - name: Upload state artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform.tfstate.pulled

      - name: Summary
        run: |
          echo "✅ State récupéré depuis Terraform Cloud" >> $GITHUB_STEP_SUMMARY
          echo "Télécharge l’artifact **terraform-state** pour récupérer le fichier." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # State push : pousse un fichier state présent dans le repo vers Terraform Cloud
  # Le fichier doit être committé (ex. terraform.tfstate.push) avant de lancer l’action.
  # Pense à supprimer le fichier du repo après le push (données sensibles).
  # ---------------------------------------------------------------------------
  state-push:
    name: State Push
    runs-on: ubuntu-latest
    if: github.event.inputs.operation == 'state-push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Vérifier présence du fichier state
        run: |
          PATH="${{ github.event.inputs.state_file_path }}"
          if [ ! -f "$PATH" ]; then
            echo "::error::Fichier introuvable : $PATH"
            echo "Commite le state à pousser à ce chemin (ex. terraform.tfstate.push) puis relance l’action."
            exit 1
          fi
          echo "Fichier trouvé : $PATH"

      - name: Terraform Init
        run: terraform init

      - name: State Push
        run: terraform state push -force -lock=false "${{ github.event.inputs.state_file_path }}"

      - name: Summary
        run: echo "✅ State poussé vers Terraform Cloud" >> $GITHUB_STEP_SUMMARY
